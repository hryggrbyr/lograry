---
/* src/pages/admin.astro */
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lograry Admin | Quick Capture</title>
    <link rel="manifest" href={`${import.meta.env.BASE_URL}manifest.json`} />
    <link
      href={`${import.meta.env.BASE_URL}admin/config.yml`}
      type="text/yaml"
      rel="shortcut config"
    />
    <style>
      #quick-capture {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        background: #1a1a1a;
        color: #eee;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid #333;
        font-family: system-ui, sans-serif;
      }
      input {
        background: #000;
        border: 1px solid #444;
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px;
        flex-grow: 1;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #2563eb;
      }
      #status {
        font-size: 0.8rem;
        min-width: 150px;
      }
    </style>
  </head>
  <body>
    <div id="quick-capture">
      <span>üöÄ</span>
      <span>
        <input
          type="text"
          id="query"
          placeholder="Search Title, Author, or ISBN..."
        />
        <div id="status">Ready</div>
      </span>
      <button id="search-btn">Search & Copy</button>
    </div>

    <script
      is:inline
      src="https://unpkg.com/@sveltia/cms@latest/dist/sveltia-cms.js"></script>

    <script is:inline>
      CMS.registerPreviewStyle(`${import.meta.env.BASE_URL}admin/preview.css`);
    </script>

    <script is:inline>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register(`${import.meta.env.BASE_URL}sw.js`)
            .then(
              (registration) => {
                console.log(
                  "ServiceWorker registration successful with scope: ",
                  registration.scope,
                );
              },
              (err) => {
                console.log("ServiceWorker registration failed: ", err);
              },
            );
        });
      }
    </script>

    <script>
      document.getElementById("search-btn").onclick = async () => {
        const query = document.getElementById("query").value;
        const status = document.getElementById("status");
        if (!query) return;

        status.innerText = "Searching Open Library...";

        try {
          // Open Library Search API
          const searchUrl = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=1`;
          const response = await fetch(searchUrl);
          const data = await response.json();

          if (data.docs && data.docs.length > 0) {
            const book = data.docs[0];

            // Map the API data to YOUR specific Zod schema fields
            const capture = {
              title: book.title,
              subtitle: book.subtitle || "",
              author: book.author_name || [],
              published: book.first_publish_year?.toString() || "",
              publisher: book.publisher?.[0] || "",
              page_count: book.number_of_pages_median || null,
              isbn: book.isbn?.[0] || "",
              coverUrl: book.cover_i
                ? `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg`
                : "",
              shelf: "to-read", // Default for new captures
            };

            // Format as YAML-ready string
            const yamlString = Object.entries(capture)
              .map(([key, val]) => `${key}: ${JSON.stringify(val)}`)
              .join("\n");

            await navigator.clipboard.writeText(yamlString);
            status.innerText = "‚úì Found & Copied YAML!";
            document.getElementById("query").value = ""; // Clear input
          } else {
            status.innerText = "‚ùå No results found.";
          }
        } catch (e) {
          console.error(e);
          status.innerText = "‚ö†Ô∏è Fetch Error.";
        }
      };
    </script>
  </body>
</html>
