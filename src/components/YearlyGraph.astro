---
interface Props {
  items: any[];
  type: "book" | "movie" | "series" | "all";
}

const { items, type } = Astro.props;

const currentYear = new Date().getFullYear();

// 1. Unify dates based on type
const allFinished = items
  .map((item) => {
    // Check for end_date (books) or watched (media)
    const dateValue = item.data.end_date || item.data.watched;
    return dateValue ? { date: new Date(dateValue) } : null;
  })
  .filter(Boolean) as { date: Date }[];

// 2. Determine labels
const labels = {
  book: "Reading",
  movie: "Viewing",
  series: "Viewing",
  all: "Consumption",
};
const dateLabel = type === "book" ? "Read" : "Watched";

// 3. Determine start year
const startYear =
  allFinished.length > 0
    ? Math.min(...allFinished.map((item) => item.date.getFullYear()))
    : currentYear - 5;

// 4. Populate Map
const yearMap = new Map();
for (let y = startYear; y <= currentYear; y++) {
  yearMap.set(y, 0);
}

allFinished.forEach((item) => {
  const year = item.date.getFullYear();
  if (yearMap.has(year)) {
    yearMap.set(year, yearMap.get(year) + 1);
  }
});

const data = Array.from(yearMap.values());
const maxCount = Math.max(...data);

// 5. SVG Layout
const width = 800;
const height = 150;
const padding = 10;

const points =
  data.length > 1
    ? data
        .map((count, i) => {
          const x = (i / (data.length - 1)) * (width - padding * 2) + padding;
          const y =
            maxCount > 0
              ? height - padding - (count / maxCount) * (height - padding * 2)
              : height - padding;
          return `${x},${y}`;
        })
        .join(" ")
    : `${padding},${height / 2} ${width - padding},${height / 2}`;
---

<div class="stats-container flow">
  <div class="graph-header">
    <h3>{labels[type]} Velocity</h3>
    <div class="stats-meta">
      <span>{allFinished.length} Items {dateLabel}</span>
      <span class="divider">|</span>
      <span>{startYear} â€” {currentYear}</span>
    </div>
  </div>

  <svg
    viewBox={`0 0 ${width} ${height}`}
    preserveAspectRatio="none"
    class="graph-svg"
  >
    <defs>
      <filter id="sketchy">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.02 0.05"
          numOctaves="1"
          result="t"></feTurbulence>
        <feDisplacementMap in="SourceGraphic" in2="t" scale="3"
        ></feDisplacementMap>
      </filter>
    </defs>

    <line
      x1={padding}
      y1={height - padding}
      x2={width - padding}
      y2={height - padding}
      stroke="currentColor"
      opacity="0.1"></line>

    <polyline
      fill="none"
      stroke="var(--color-handwriting)"
      stroke-width="3"
      stroke-linecap="round"
      stroke-linejoin="round"
      points={points}
      filter="url(#sketchy)"></polyline>
  </svg>
</div>

<style>
  .graph-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .divider {
    margin: 0 0.4rem;
    opacity: 0.3;
  }
  .graph-svg {
    width: 100%;
    height: 120px;
    overflow: visible;
  }
</style>
