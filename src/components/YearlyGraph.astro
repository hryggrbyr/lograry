---
import { getCollection } from "astro:content";

const allBooks = await getCollection("books");
const currentYear = new Date().getFullYear();
const startYear = 1986;

// 1. Filter only 'read' books and those with valid end_dates
const readBooks = allBooks.filter(
  (book) => book.data.shelf === "read" && book.data.end_date,
);

// 2. Initialize the map
const yearMap = new Map();
for (let y = startYear; y <= currentYear; y++) {
  yearMap.set(y, 0);
}

// 3. Populate the map
readBooks.forEach((book) => {
  const date = new Date(book.data.end_date);
  const year = date.getFullYear();
  console.log(">>>", date);

  if (yearMap.has(year)) {
    yearMap.set(year, yearMap.get(year) + 1);
  }
});

const data = Array.from(yearMap.values());
const maxCount = Math.max(...data);

// 4. SVG Dimensions
const width = 800;
const height = 150;
const padding = 20;

// 5. Generate Points (Fixing the Y-axis calculation)
// If maxCount is 0 (no books read), we set y to the bottom of the graph.
const points = data
  .map((count, i) => {
    const x = (i / (data.length - 1)) * (width - padding * 2) + padding;

    // Calculate Y: Invert it because SVG 0 is at the top
    // We use (height - padding) as the baseline (bottom)
    const usableHeight = height - padding * 2;
    const y =
      maxCount > 0
        ? height - padding - (count / maxCount) * usableHeight
        : height - padding;

    return `${x},${y}`;
  })
  .join(" ");
---

<div class="stats-container">
  <div class="graph-header">
    <h3>Reading Velocity</h3>
    <div class="stats-meta">
      <span>{readBooks.length} Total Read</span>
      <span class="divider">|</span>
      <span>{startYear} â€” {currentYear}</span>
    </div>
  </div>

  <svg
    viewBox={`0 0 ${width} ${height}`}
    preserveAspectRatio="none"
    class="graph-svg"
  >
    <defs>
      <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="3" result="blur"></feGaussianBlur>
        <feComposite in="SourceGraphic" in2="blur" operator="over"
        ></feComposite>
      </filter>
    </defs>

    <line
      x1={padding}
      y1={height - padding}
      x2={width - padding}
      y2={height - padding}
      stroke="var(--accent-100)"
      stroke-width="1"
      stroke-opacity="0.2"></line>

    <polyline
      fill="none"
      stroke="var(--secondary-900)"
      stroke-width="3"
      stroke-linecap="round"
      stroke-linejoin="round"
      points={points}
      filter="url(#glow)"></polyline>
  </svg>
</div>

<style>
  .graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .graph-header :not(h3) {
    font-size: 0.8em;
  }
  .divider {
    margin: 0 0.5rem;
    opacity: 0.3;
  }
  .graph-svg {
    width: 100%;
    height: 10rlh; /* Force a height for visibility */
    overflow: visible;
  }
</style>
