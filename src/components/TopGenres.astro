---
interface Props {
  items: any[];
  type: "book" | "movie" | "series" | "all";
  year?: number;
}

const { items, type, year } = Astro.props;

// 1. Filter items by year if the prop is provided
// This checks both end_date (books) and watched (media)
const filteredItems = year
  ? items.filter((item) => {
      const dateValue = item.data.end_date || item.data.watched;
      if (!dateValue) return false;
      const date = new Date(dateValue);
      return date.getFullYear() === year;
    })
  : items;

// 2. Count occurrences (coalescing tags and genre)
const counts = new Map<string, number>();
filteredItems.forEach((item) => {
  // Use tags for books, genre for movies/series
  const categories = item.data.tags || item.data.genre || [];
  categories.forEach((cat: string) => {
    counts.set(cat, (counts.get(cat) || 0) + 1);
  });
});

// 3. Sort and Slice
const sortedData = Array.from(counts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

const maxCount = sortedData.length > 0 ? sortedData[0][1] : 0;

// Dynamic title
const label = type === "book" ? "Tags" : "Genres";
---

<div class="genre-chart-container flow">
  <h3>Top 10 {label} {year && `(${year})`}</h3>

  {
    sortedData.length > 0 ? (
      <ul class="genre-list flow">
        {sortedData.map(([name, count]) => (
          <li class="genre-item">
            <span class="genre-name">{name}</span>
            <div class="bar-container">
              <svg width="100%" height="20" preserveAspectRatio="none">
                <defs>
                  <filter id="sketchy-bar">
                    <feTurbulence
                      type="fractalNoise"
                      baseFrequency="0.05 0.01"
                      numOctaves="1"
                      result="turbulence"
                    />
                    <feDisplacementMap
                      in="SourceGraphic"
                      in2="turbulence"
                      scale="2"
                    />
                  </filter>
                </defs>
                <line
                  x1="0"
                  y1="10"
                  x2={`${(count / maxCount) * 100}%`}
                  y2="10"
                  stroke="var(--color-handwriting)"
                  stroke-width="3"
                  stroke-linecap="round"
                  filter="url(#sketchy-bar)"
                />
              </svg>
            </div>
            <span class="genre-count">{count}</span>
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-muted">No data available for this selection.</p>
    )
  }
</div>

<style>
  .genre-list {
    --flow-gap: 0.25rlh;
    list-style: none;
    padding: 0;
  }

  .genre-item {
    display: grid;
    grid-template-columns: 120px 1fr 40px;
    gap: 1rem;
    align-items: center;
  }

  .genre-name {
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--color-text-muted);
  }

  .bar-container {
    width: 100%;
    display: flex;
    align-items: center;
  }

  .genre-count {
    text-align: right;
    font-weight: bold;
  }

  h3 {
    margin-bottom: 1rem;
  }
</style>
